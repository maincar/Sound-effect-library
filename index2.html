<!DOCTYPE html>
<html lang="ja">
<head>
  <meta name="google-site-verification" content="OZUXnz2dq-uqkAN4pJ6e1ynbfsdCJkLxc9Nsod7xL_Y" />
  <meta charset="UTF-8">
  <title>効果音リンク集</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  padding: 16px;
  background: #f5f5f5;
}

h1 {
  text-align: center;
  margin-bottom: 12px;
}

.controls {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

#search, #sort {
  width: 100%;
  padding: 12px;
  font-size: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.categories {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  margin-bottom: 16px;
}

.categories button {
  padding: 8px 14px;
  border-radius: 20px;
  border: none;
  background: #ddd;
  font-size: 14px;
  white-space: nowrap;
}

.categories button.active {
  background: #333;
  color: #fff;
}

.list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
}

.card {
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  text-decoration: none;
  color: #000;
}

.card img {
  width: 100%;
  aspect-ratio: 16 / 9;
  object-fit: cover;
}

.card-title {
  padding: 6px;
  font-size: 14px;
  text-align: center;
}

.card-category {
  padding-bottom: 6px;
  font-size: 12px;
  text-align: center;
  color: #666;
}

/* 広告カード */
.ad-card {
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  text-decoration: none;
  color: #000;
}

.ad-card img {
  width: 100%;
  aspect-ratio: 16 / 9;
  object-fit: cover;
}

.ad-title {
  padding: 6px;
  font-size: 14px;
  text-align: center;
}

.ad-label {
  font-size: 11px;
  color: #666;
  text-align: center;
  padding-bottom: 6px;
}

/* スマホ下部バナー */
#bottomAd {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: none;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  background: #fff;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.2);
  z-index: 1000;
}

#bottomAd img {
  height: 40px;
}

#bottomAd button {
  margin-left: auto;
  border: none;
  background: #ccc;
  border-radius: 4px;
}

</style>
</head>

<body>

<h1>効果音リンク集</h1>

<div class="controls">
  <input id="search" type="text" placeholder="検索">
  <select id="sort">
    <option value="new">新着順</option>
    <option value="old">古い順</option>
    <option value="title-asc">タイトル昇順</option>
    <option value="title-desc">タイトル降順</option>
  </select>
</div>

<div class="categories" id="categories"></div>

<div class="list" id="list"></div>

<div id="bottomAd">
  <a id="bottomLink" target="_blank">
    <img id="bottomImg">
  </a>
  <button id="bottomClose">×</button>
</div>

<script>
const SHEET_ID = "ここにスプレッドシートID";
const SHEET_NAME = "シート1";

const ADS_SHEET = "ads";
const ADS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${ADS_SHEET}`;

const params = new URLSearchParams(location.search);
const soundSlug = params.get("sound");

let ads = {
  feed: [],
  bottom: []
};

const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

let data = [];
let currentCategory = "すべて";

fetch(ADS_URL)
  .then(res => res.text())
  .then(text => {
    const rows = text.trim().split("\n").slice(1);
    rows.forEach(row => {
      const [enabled, type, title, image, link] =
        row.replace(/"/g, "").split(",");
      if (enabled === "ON" && ads[type]) {
        ads[type].push({ title, image, link });
      }
    });
    setupBottomAd();
  });

fetch(CSV_URL)
  .then(res => res.text())
  .then(text => {
    const rows = text.trim().split("\n").slice(1);
    data = rows.map((row, index) => {
      const cols = row.replace(/"/g,"").split(",");
        return {
        index,
        title: cols[0],
        url: cols[1],
        category: cols[2] || "未分類",
        slug: cols[3]
        };
    });
    buildCategories();
    render();
  });

function buildCategories() {
  const cats = ["すべて", ...new Set(data.map(d => d.category))];
  const el = document.getElementById("categories");
  el.innerHTML = "";

  cats.forEach(cat => {
    const btn = document.createElement("button");
    btn.textContent = cat;
    if (cat === currentCategory) btn.classList.add("active");
    btn.onclick = () => {
      currentCategory = cat;
      document.querySelectorAll(".categories button")
        .forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      render();
    };
    el.appendChild(btn);
  });
}

function getThumbnail(url) {
  const id = url.split("v=")[1];
  return `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
}

function render() {

  // ▼ 個別効果音ページ
  if (soundSlug) {
    const item = data.find(d => d.slug === soundSlug);
    if (!item) return;

    // SEO反映
    document.title = `${item.title} 効果音｜無料効果音`;
    setMetaDescription(`${item.title}の効果音です。YouTubeで視聴できます。`);

    document.querySelector("h1").textContent = item.title;

    document.getElementById("list").innerHTML = `
      <a class="card" href="${item.url}" target="_blank">
        <img src="${getThumbnail(item.url)}">
        <div class="card-title">${item.title}</div>
        <div class="card-category">${item.category}</div>
      </a>
    `;

    return;
  }

  // ▼ 一覧表示（従来処理）
  const keyword = document.getElementById("search").value.toLowerCase();
  const sortType = document.getElementById("sort").value;

  let list = data.filter(d => {
    const matchCategory =
      currentCategory === "すべて" || d.category === currentCategory;
    const matchKeyword =
      d.title.toLowerCase().includes(keyword);
    return matchCategory && matchKeyword;
  });

  // 並び替え
  list.sort((a, b) => {
    switch (sortType) {
      case "old":
        return a.index - b.index;
      case "title-asc":
        return a.title.localeCompare(b.title, "ja");
      case "title-desc":
        return b.title.localeCompare(a.title, "ja");
      default: // new
        return b.index - a.index;
    }
  });

  const el = document.getElementById("list");
  el.innerHTML = "";

list.forEach((item, i) => {

  el.innerHTML += `
    <a class="card" href="?sound=${item.slug}">
      <img src="${getThumbnail(item.url)}">
      <div class="card-title">${item.title}</div>
      <div class="card-category">${item.category}</div>
    </a>
  `;

  if ((i + 1) % 8 === 0 && ads.feed.length) {
    const ad = ads.feed[i % ads.feed.length];
    el.innerHTML += `
      <a class="ad-card" href="${ad.link}" target="_blank">
        <img src="${ad.image}">
        <div class="ad-title">${ad.title}</div>
        <div class="ad-label">広告</div>
      </a>
    `;
  }
});

}

document.getElementById("search").addEventListener("input", render);
document.getElementById("sort").addEventListener("change", render);

function setupBottomAd() {
  if (!ads.bottom.length) return;

  const ad = ads.bottom[0];
  document.getElementById("bottomImg").src = ad.image;
  document.getElementById("bottomLink").href = ad.link;
  document.getElementById("bottomAd").style.display = "flex";

  document.getElementById("bottomClose").onclick = () => {
    document.getElementById("bottomAd").style.display = "none";
  };
}


function buildSeoText(list) {
  const seoEl = document.getElementById("seo-text");

  const titles = list.map(item => `${item.title} 効果音`);

  seoEl.innerHTML = `
    <h2>効果音一覧</h2>
    <p>${titles.join("、")}</p>
  `;
}

function setMetaDescription(text) {
  let meta = document.querySelector("meta[name='description']");
  if (!meta) {
    meta = document.createElement("meta");
    meta.name = "description";
    document.head.appendChild(meta);
  }
  meta.content = text;
}

</script>

<!-- SEO用 自動生成テキスト -->
<section id="seo-text" style="display:none;"></section>
</body>
</html>
